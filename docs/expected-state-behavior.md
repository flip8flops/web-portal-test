# Expected State Behavior for Broadcast Page

## Campaign Status Definitions

### 1. **`idle`** - No active campaign
**Database State:**
- No campaign with `status = 'content_drafted'`
- No campaign with `status = 'processing'`

**Tab Input:**
- ✅ **Active**: All form fields (notes, image upload, generate button) are **ENABLED**
- ✅ **Status Display**: Empty or shows "No active campaign"
- ✅ **Tab**: Can be on Input or Output (user choice)

**Tab Output:**
- ✅ **Content**: Shows "No draft available. Generate a campaign first in the Input tab."
- ✅ **Actions**: No actions available

**localStorage:**
- ✅ **Cleared**: `current_campaign_id`, `current_execution_id`, `current_campaign_timestamp` should be **null/removed**

---

### 2. **`processing`** - Campaign is being generated by agents
**Database State:**
- Campaign exists with `status = 'processing'` OR
- `campaign_status_updates` has entries with `status = 'processing'` or `status = 'thinking'`

**Tab Input:**
- ✅ **Locked**: All form fields (notes, image upload, generate button) are **DISABLED**
- ✅ **Status Display**: Shows all agent statuses (Guardrails In, Research, Matchmaker, Content Maker, Guardrails Out) with real-time updates
- ✅ **Tab**: Should be on Input tab (auto-locked)

**Tab Output:**
- ✅ **Content**: Shows "Campaign is being processed..." or similar message
- ✅ **Actions**: No actions available

**localStorage:**
- ✅ **Saved**: `current_campaign_id`, `current_execution_id`, `current_campaign_timestamp` should be **saved**

---

### 3. **`drafted`** - Campaign content is ready for review
**Database State:**
- Campaign exists with `status = 'content_drafted'`
- `campaign_status_updates` shows:
  - `content_maker_agent` with `status = 'completed'`
  - `guardrails` (QC phase) with `status = 'completed'` and `workflow_point` includes `guardrails_checking` or `guardrails_completed`

**Tab Input:**
- ✅ **Locked**: All form fields (notes, image upload, generate button) are **DISABLED**
- ✅ **Status Display**: Shows all completed agent statuses (Guardrails In, Research, Matchmaker, Content Maker, Guardrails Out) with final status messages
- ✅ **Tab**: Can be on Input or Output (user choice, but Input is locked)

**Tab Output:**
- ✅ **Content**: Shows draft campaign details:
  - Campaign info (title, objective, tags, notes, total matched audience)
  - Audience list (left side)
  - Audience detail with draft content (right side)
- ✅ **Actions**: 
  - "Approve & Send" button (active when audiences selected)
  - "Reject" button (active, can reject all)

**localStorage:**
- ✅ **Saved**: `current_campaign_id`, `current_campaign_timestamp` should be **saved** (no execution_id needed)

---

### 4. **`rejected`** - Campaign has been rejected by admin
**Database State:**
- Campaign exists with `status = 'rejected'`
- `campaign_status_updates` has entry with `agent_name = 'broadcast_reject'` and `status = 'rejected'`

**Tab Input:**
- ✅ **Active**: All form fields (notes, image upload, generate button) are **ENABLED**
- ✅ **Status Display**: Empty or shows "No active campaign"
- ✅ **Tab**: Should be on Input tab (auto-switch from Output)

**Tab Output:**
- ✅ **Content**: Shows alert message: "Campaign has been rejected. You can now create a new campaign in the Input tab."
- ✅ **Actions**: No actions available

**localStorage:**
- ✅ **Cleared**: `current_campaign_id`, `current_execution_id`, `current_campaign_timestamp` should be **null/removed**

---

### 5. **`approved`** - Campaign has been approved and sent
**Database State:**
- Campaign exists with `status = 'approved'` or `status = 'sent'`
- `campaign_status_updates` has entry with `agent_name = 'broadcast_send'` and `status = 'completed'`

**Tab Input:**
- ✅ **Active**: All form fields (notes, image upload, generate button) are **ENABLED**
- ✅ **Status Display**: Empty or shows "No active campaign"
- ✅ **Tab**: Should be on Input tab (auto-switch from Output)

**Tab Output:**
- ✅ **Content**: Shows alert message: "Campaign has been sent successfully. You can now create a new campaign in the Input tab."
- ✅ **Actions**: No actions available

**localStorage:**
- ✅ **Cleared**: `current_campaign_id`, `current_execution_id`, `current_campaign_timestamp` should be **null/removed**

---

## State Transition Rules

### After Page Refresh:
1. **First Check**: Call `findLatestDraftCampaign()` to get latest `content_drafted` campaign
2. **If found**: Verify `campaign.status === 'content_drafted'` → Set state to `'drafted'`
3. **If not found**: Check `localStorage` for `current_campaign_id`
4. **If saved campaign exists**: Call `checkCampaignState(savedCampaignId)`
   - If `'rejected'` or `'approved'` → **Clear localStorage and set state to `'idle'`**
   - If `'drafted'` → **Restore state to `'drafted'`**
   - If `'processing'` → **Restore state to `'processing'`**
   - If `'idle'` → **Clear localStorage and set state to `'idle'`**
5. **If no saved campaign**: Set state to `'idle'`

### After Reject:
1. **API Call**: `/api/drafts/reject` updates database (`campaign.status = 'rejected'`)
2. **Immediate UI Update**: 
   - Set `draftCampaignId = null`
   - Set `campaignId = null`
   - Set `executionId = null`
   - Set `campaignState = 'idle'`
   - Set `activeTab = 'input'`
   - **Clear localStorage** (remove all campaign-related keys)
3. **After Refresh**: Should follow "After Page Refresh" rules above, which should detect `'rejected'` and clear state

### After Approve & Send:
1. **API Call**: `/api/drafts/approve` and `/api/drafts/send` update database (`campaign.status = 'approved'` or `'sent'`)
2. **Immediate UI Update**: 
   - Set `draftCampaignId = null`
   - Set `campaignId = null`
   - Set `executionId = null`
   - Set `campaignState = 'idle'`
   - Set `activeTab = 'input'`
   - **Clear localStorage** (remove all campaign-related keys)
3. **After Refresh**: Should follow "After Page Refresh" rules above, which should detect `'approved'` and clear state

---

## Critical Checks

### `checkCampaignState(campaignId)` must correctly detect:
- ✅ `'processing'`: If any status update has `status = 'processing'` or `'thinking'`
- ✅ `'drafted'`: If `content_maker_agent` completed AND `guardrails` (QC) completed
- ✅ `'rejected'`: If `campaign.status = 'rejected'` OR status update has `agent_name = 'broadcast_reject'`
- ✅ `'approved'`: If `campaign.status = 'approved'` OR `campaign.status = 'sent'` OR status update has `agent_name = 'broadcast_send'`
- ✅ `'idle'`: If none of the above

### `findLatestDraftCampaign()` must:
- ✅ Only return campaigns with `campaign.status = 'content_drafted'`
- ✅ Verify status before returning (final check)
- ✅ Return `null` if no draft found or if campaign is `'rejected'`/`'approved'`

### Guardrails Detection:
- ✅ **Guardrails In**: `workflow_point = 'start'` OR includes `'guardrails_accepted'` OR `'guardrails_rejected'`
- ✅ **Guardrails Out**: `workflow_point` includes `'guardrails_checking'` OR `'guardrails_completed'` OR `'guardrails_error'` OR comes after `content_maker_agent` completed
